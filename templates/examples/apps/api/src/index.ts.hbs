import { Elysia } from "elysia";
import { cors } from "@elysiajs/cors";
import { betterAuthPlugin } from "@/middleware/auth";
import { errorHandler } from "@/middleware/error-handler";
import { requestLogger } from "@/middleware/request-logger";
import { authRoutes } from "@/routes/auth";
import { postsRoutes } from "@/routes/posts";
import { logger } from "@/lib/logger";
import { prisma } from "{{PACKAGE_SCOPE}}/database";

const allowedOrigins = (
  process.env.ALLOWED_ORIGINS ?? "http://localhost:3000"
)
  .split(",")
  .map((origin: string) => origin.trim())
  .filter(Boolean);

const app = new Elysia()
  .use(
    cors({
      origin: allowedOrigins,
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
      credentials: true,
      allowedHeaders: ["Content-Type", "Authorization"],
    }),
  )
  .use(errorHandler)
  .use(requestLogger)
  .use(betterAuthPlugin)
  .get("/health", () => ({
    status: "ok",
    timestamp: new Date().toISOString(),
  }))
  .group("/api/v1", (app) =>
    app
      .use(authRoutes)
      .use(postsRoutes),
  )
  .listen(process.env.PORT || 8080);

export type App = typeof app;

const host = app.server?.hostname;
const port = app.server?.port;
logger.info({ host, port }, "{{PROJECT_TITLE}} API started");

process.on("SIGTERM", async () => {
  logger.info("Received SIGTERM, shutting down gracefully...");
  await prisma.$disconnect();
  process.exit(0);
});

process.on("SIGINT", async () => {
  logger.info("Received SIGINT, shutting down gracefully...");
  await prisma.$disconnect();
  process.exit(0);
});
